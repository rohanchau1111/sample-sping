plugins {
    id 'java'
    id 'maven-publish'
  id 'com.jfrog.artifactory' version '5.1.12'
}

dependencies {
  implementation 'com.example:my-jar-artifact:1.0.0' // Coordinates of the JAR file
    implementation 'ch.appuio.techlab:artifactorytest:0.1.1-SNAPSHOT'
    
}

    repositories {
    maven {
        url "http://172.27.225.231:8082/artifactory/gradle-dev-local" // Replace with your Artifactory repository URL
      allowInsecureProtocol=true
      credentials {
            username = "admin"
            password = "DevOp9@"
        }
//     allowInsecureProtocol = true
    }
}
// Create a custom configuration that extends 'implementation' and is resolvable
configurations {
    resolvedImplementation {
        canBeResolved = true
        canBeConsumed = false
        extendsFrom configurations.implementation
    }
}

// Task to ensure dependencies are resolved
task ensureDependenciesResolved {
    doLast {
        configurations.resolvedImplementation.resolve()
    }
}

// Task to print the path of the downloaded JAR file
task printDependencyPath {
    dependsOn ensureDependenciesResolved
    doLast {
        configurations.resolvedImplementation.resolvedConfiguration.resolvedArtifacts.each { artifact ->
            if (artifact.file.name.endsWith('.jar')) {
                println "Dependency JAR file path: ${artifact.file.absolutePath}"
            }
        }
    }
}

// Task to copy the JAR file to a specific directory
task copyDependencies(type: Copy) {
    dependsOn ensureDependenciesResolved
    from {
        configurations.resolvedImplementation.resolvedConfiguration.resolvedArtifacts.collect { it.file }
    }
    into "$buildDir/libs"
}


task createZip(type: Zip) {

    from file('test')
    archiveFileName.set('test.zip')
    destinationDirectory.set(file("$buildDir/libs/"))

  //  from "$buildDir/libs/"
   doLast {
   println 'Zip file created at ${destinationDirectory}/${archiveFileName}'
}
   doFirst {

   println 'archiving file ....${archiveName}'
}
}


publishing {
  publications {
     mavenJava(MavenPublication) {
     artifact("${buildDir}/libs/test.zip") {
    classifier = ''
   extension = 'zip'
}
}
}
    repositories {
    maven {
        url "http://172.27.225.231:8082/artifactory/gradle-dev-local" // Replace with your Artifactory repository URL
      allowInsecureProtocol=true
      credentials {
            username = "admin"
            password = "DevOp9@"
        }
//     allowInsecureProtocol = true
    }
}
}

artifactory {
    contextUrl = 'http://172.27.225.231:8082/artifactory'
    publish {
        repository {
            repoKey = 'gradle-dev-local' // Ensure this matches your Artifactory repository key
            username = 'admin'
            password = 'DevOps9@'
        }
        defaults {
          publications('mavenJava') // Must match the publication name in the publishing block
          publications('bootJava')
         publishArtifacts = true
        }
    }
}


// Ensure the build depends on both tasks
tasks.build {
    dependsOn copyDependencies
    dependsOn printDependencyPath
    dependsOn  createZip
}
